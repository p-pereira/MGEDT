<!DOCTYPE html>
<html lang="en">
<head>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
    <!--<link rel="stylesheet" href="style.css">-->
    <title>Evolution Progress</title>
</head>
<body>

    <h1 style="text-align: center;"> Multi-objective Grammatical Evolution Decision Trees</h1>
    <br/>
    
    
    <div class="container" >
        <div class="row">
            <div class="col-xs-6">
                <canvas id="line-chart" width="200" height="200"></canvas>
            </div>
            <div class="col-xs-6">
                <canvas id="pareto" width="200" height="200"></canvas>
            </div>
        </div>
        
    </div>
    <div class="progress" style="width: 70%; position: relative; margin: auto;" >
            <div class="progress-bar progress-bar-striped " role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%" id="prog_bar">
                <span class="progress-bar-label" id="prog_bar_label">0%</span>
            </div>
        </div>

        <p id="gen_info" style="text-align: center;">Training model: <b id="cur_iter">0</b> of <b id="total_iter">-</b> iterations.</p>
    <!--<div style="position: relative; margin: auto; height: 50vh; width: 70%;">
        <canvas id="line-chart"></canvas>
        <canvas id="line-chart2"></canvas>
    </div>-->
    
    

    <script>
        var ctx = document.getElementById("line-chart");
        var ctx2 = document.getElementById("pareto");
        var config = {
            type: 'line',
            data: {
                labels: [0],
                datasets: [
                    {
                        data: [],
                        label: 'Best AUC',
                        borderColor : "#3e95cd",
                        fill : false
                    },
                    {
                        data : [],
                        label : 'Pareto-front Mean AUC',
                        borderColor : "#c45850",
                        fill :false
                    }]
            },
            options: {
                maintainAspectRatio: true,
                responsive : true,
                scales: {
                    xAxes: [{
                        ticks: {
                            display: false
                        },
                        scaleLabel : {
                            display : true,
                            labelString : 'Generation'
                        }
                    }],
                    yAxes: [{
                        scaleLabel : {
                            display : true,
                            labelString : 'AUC'
                        }
                    }]
                },
                title: {
                    display: true,
                    text: 'Population Evolution'
                }
            }
        };
        var config2 = {
            type: 'line',
            options: {
                maintainAspectRatio: true,
                responsive : true,
                legend : {
                    display : false
                },
                title: {
                    display: true,
                    text: 'Pareto Front Evolution'
                },
                scales: {
                    xAxes: [{
                        ticks: {
                            display: true
                        },
                        scaleLabel : {
                            display : true,
                            labelString : '-AUC'
                        }
                    }],
                    yAxes: [{
                        scaleLabel : {
                            display : true,
                            labelString : 'Complexity (log)'
                        }
                    }]
                }
            }
        };

        var chart = new Chart(ctx, config);
        var chart2 = new Chart(ctx2, config2);
        
        function addData(char, label, data) {
                console.log(label);
                console.log(data);
            char.data.labels.push(label);
            l = char.data.datasets.length;
            for (i = 0; i < l; i++) {
                char.data.datasets[i].data.push(data[i]);
            }
            char.update();
        }

        function addData2(char2, label, data) {
            console.log(label);
            console.log(data);
            all_labels = char2.data.labels.concat(label);
            unique_labels = [... new Set(all_labels)];
            unique_labels = unique_labels.sort(function(a, b){return a-b});

            char2.data.labels = unique_labels;

            char2.data.datasets.push(data);
            char2.update();
        }
        console.log("Opening the SSE connection");
    var curr_gen = 0
    var source = new EventSource("/progress");
    source.onmessage = function(event) {
            sent_data = JSON.parse(event.data);
            //console.log(sent_data)
            console.log(sent_data);
            // extract info from json
            percentage = sent_data['percentage'];
            total = sent_data['total'];
            gen = sent_data['gen'];
            label = sent_data['label'];
            grapich_data = sent_data['data_graphic'];
            pareto = sent_data['pareto']
            pareto_auc = sent_data['pareto_auc']
            // data received is in the form : {'0':value, '1':value}
            qi = "#prog_bar";
            $(qi).css('width',percentage+'%').attr('aria-valuenow', percentage);
            lqi = qi+"_label";
            $(lqi).text(percentage+'%');
            
            var info_p = document.getElementById("gen_info");
            if (gen === 0) {
                    info_p.innerHTML = "Starting training...";
            } else {
                info_p.innerHTML = '<p id="gen_info">Training model: <b id="cur_iter">0</b> of <b id="total_iter">-</b> iterations.</p>';
                var element = document.getElementById("total_iter");
                        element.innerHTML = total;
                var element = document.getElementById("cur_iter");
                        element.innerHTML = gen;
            }

            //var ctx = document.getElementById("line-chart")
            //if(gen>0 && (!chart.data.labels.includes(label))) {
            //        addData(chart, label, grapich_data);
            //}
            if(gen>0 && curr_gen != gen) {
                    addData(chart, label, grapich_data);
                    addData2(chart2, pareto_auc, pareto);
                    curr_gen = gen;
            }
            if(percentage === 100){
                console.log("Closing the SSE connection");
                source.close();
            }
        };
    </script>

</body>
</html>